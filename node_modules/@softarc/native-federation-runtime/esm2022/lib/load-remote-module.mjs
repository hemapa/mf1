/* eslint-disable @typescript-eslint/no-explicit-any */
import { appendImportMap } from './utils/add-import-map';
import { processRemoteInfo } from './init-federation';
import { getRemote, getRemoteNameByBaseUrl, isRemoteInitialized, } from './model/remotes';
import { getDirectory, joinPaths } from './utils/path-utils';
export async function loadRemoteModule(optionsOrRemoteName, exposedModule) {
    const options = normalizeOptions(optionsOrRemoteName, exposedModule);
    await ensureRemoteInitialized(options);
    const remoteName = getRemoteNameByOptions(options);
    const remote = getRemote(remoteName);
    const fallback = options.fallback;
    const remoteError = !remote ? 'unknown remote ' + remoteName : '';
    if (!remote && !fallback) {
        throw new Error(remoteError);
    }
    else if (!remote) {
        logClientError(remoteError);
        return Promise.resolve(fallback);
    }
    const exposed = remote.exposes.find((e) => e.key === options.exposedModule);
    const exposedError = !exposed
        ? `Unknown exposed module ${options.exposedModule} in remote ${remoteName}`
        : '';
    if (!exposed && !fallback) {
        throw new Error(exposedError);
    }
    else if (!exposed) {
        logClientError(exposedError);
        return Promise.resolve(fallback);
    }
    const url = joinPaths(remote.baseUrl, exposed.outFileName);
    try {
        const module = _import(url);
        return module;
    }
    catch (e) {
        if (fallback) {
            console.error('error loading remote module', e);
            return fallback;
        }
        throw e;
    }
}
function _import(url) {
    return typeof importShim !== 'undefined'
        ? importShim(url)
        : import(/* @vite-ignore */ url);
}
function getRemoteNameByOptions(options) {
    let remoteName;
    if (options.remoteName) {
        remoteName = options.remoteName;
    }
    else if (options.remoteEntry) {
        const baseUrl = getDirectory(options.remoteEntry);
        remoteName = getRemoteNameByBaseUrl(baseUrl);
    }
    else {
        throw new Error('unexpcted arguments: Please pass remoteName or remoteEntry');
    }
    if (!remoteName) {
        throw new Error('unknown remoteName ' + remoteName);
    }
    return remoteName;
}
async function ensureRemoteInitialized(options) {
    if (options.remoteEntry &&
        !isRemoteInitialized(getDirectory(options.remoteEntry))) {
        const importMap = await processRemoteInfo(options.remoteEntry);
        appendImportMap(importMap);
    }
}
function normalizeOptions(optionsOrRemoteName, exposedModule) {
    let options;
    if (typeof optionsOrRemoteName === 'string' && exposedModule) {
        options = {
            remoteName: optionsOrRemoteName,
            exposedModule,
        };
    }
    else if (typeof optionsOrRemoteName === 'object' && !exposedModule) {
        options = optionsOrRemoteName;
    }
    else {
        throw new Error('unexpected arguments: please pass options or a remoteName/exposedModule-pair');
    }
    return options;
}
function logClientError(error) {
    if (typeof window !== 'undefined') {
        console.error(error);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1yZW1vdGUtbW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uYXRpdmUtZmVkZXJhdGlvbi1ydW50aW1lL3NyYy9saWIvbG9hZC1yZW1vdGUtbW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHVEQUF1RDtBQUN2RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDekQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEQsT0FBTyxFQUNMLFNBQVMsRUFDVCxzQkFBc0IsRUFDdEIsbUJBQW1CLEdBQ3BCLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQWtCN0QsTUFBTSxDQUFDLEtBQUssVUFBVSxnQkFBZ0IsQ0FDcEMsbUJBQXdELEVBQ3hELGFBQXNCO0lBRXRCLE1BQU0sT0FBTyxHQUFHLGdCQUFnQixDQUFDLG1CQUFtQixFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBRXJFLE1BQU0sdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFdkMsTUFBTSxVQUFVLEdBQUcsc0JBQXNCLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbkQsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3JDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7SUFFbEMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBRWxFLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QixNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9CLENBQUM7U0FBTSxJQUFJLENBQUMsTUFBTSxFQUFFLENB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Q0FBQztJQUVyQyxJQUFJLE9BQU8sbUJBQW1CLEtBQUssUUFBUSxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQzdELE9BQU8sR0FBRztZQUNSLFVBQVUsRUFBRSxtQkFBbUI7WUFDL0IsYUFBYTtTQUNkLENBQUM7SUFDSixDQUFDO1NBQU0sSUFBSSxPQUFPLG1CQUFtQixLQUFLLFFBQVEsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JFLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQztJQUNoQyxDQUFDO1NBQU0sQ0FBQztRQUNOLE1BQU0sSUFBSSxLQUFLLENBQ2IsOEVBQThFLENBQy9FLENBQUM7SUFDSixDQUFDO0lBQ0QsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLEtBQWE7SUFDbkMsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUUsQ0FBQztRQUNsQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueSAqL1xuaW1wb3J0IHsgYXBwZW5kSW1wb3J0TWFwIH0gZnJvbSAnLi91dGlscy9hZGQtaW1wb3J0LW1hcCc7XG5pbXBvcnQgeyBwcm9jZXNzUmVtb3RlSW5mbyB9IGZyb20gJy4vaW5pdC1mZWRlcmF0aW9uJztcbmltcG9ydCB7XG4gIGdldFJlbW90ZSxcbiAgZ2V0UmVtb3RlTmFtZUJ5QmFzZVVybCxcbiAgaXNSZW1vdGVJbml0aWFsaXplZCxcbn0gZnJvbSAnLi9tb2RlbC9yZW1vdGVzJztcbmltcG9ydCB7IGdldERpcmVjdG9yeSwgam9pblBhdGhzIH0gZnJvbSAnLi91dGlscy9wYXRoLXV0aWxzJztcblxuZGVjbGFyZSBmdW5jdGlvbiBpbXBvcnRTaGltPFQ+KHVybDogc3RyaW5nKTogVDtcblxuZXhwb3J0IHR5cGUgTG9hZFJlbW90ZU1vZHVsZU9wdGlvbnM8VCA9IGFueT4gPSB7XG4gIHJlbW90ZUVudHJ5Pzogc3RyaW5nO1xuICByZW1vdGVOYW1lPzogc3RyaW5nO1xuICBleHBvc2VkTW9kdWxlOiBzdHJpbmc7XG4gIGZhbGxiYWNrPzogVDtcbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUmVtb3RlTW9kdWxlPFQgPSBhbnk+KFxuICBvcHRpb25zOiBMb2FkUmVtb3RlTW9kdWxlT3B0aW9uc1xuKTogUHJvbWlzZTxUPjtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUmVtb3RlTW9kdWxlPFQgPSBhbnk+KFxuICByZW1vdGVOYW1lOiBzdHJpbmcsXG4gIGV4cG9zZWRNb2R1bGU6IHN0cmluZ1xuKTogUHJvbWlzZTxUPjtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUmVtb3RlTW9kdWxlPFQgPSBhbnk+KFxuICBvcHRpb25zT3JSZW1vdGVOYW1lOiBMb2FkUmVtb3RlTW9kdWxlT3B0aW9uczxUPiB8IHN0cmluZyxcbiAgZXhwb3NlZE1vZHVsZT86IHN0cmluZ1xuKTogUHJvbWlzZTxUPiB7XG4gIGNvbnN0IG9wdGlvbnMgPSBub3JtYWxpemVPcHRpb25zKG9wdGlvbnNPclJlbW90ZU5hbWUsIGV4cG9zZWRNb2R1bGUpO1xuXG4gIGF3YWl0IGVuc3VyZVJlbW90ZUluaXRpYWxpemVkKG9wdGlvbnMpO1xuXG4gIGNvbnN0IHJlbW90ZU5hbWUgPSBnZXRSZW1vdGVOYW1lQnlPcHRpb25zKG9wdGlvbnMpO1xuICBjb25zdCByZW1vdGUgPSBnZXRSZW1vdGUocmVtb3RlTmFtZSk7XG4gIGNvbnN0IGZhbGxiYWNrID0gb3B0aW9ucy5mYWxsYmFjaztcblxuICBjb25zdCByZW1vdGVFcnJvciA9ICFyZW1vdGUgPyAndW5rbm93biByZW1vdGUgJyArIHJlbW90ZU5hbWUgOiAnJztcblxuICBpZiAoIXJlbW90ZSAmJiAhZmFsbGJhY2spIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IocmVtb3RlRXJyb3IpO1xuICB9IGVsc2UgaWYgKCFyZW1vdGUpIHtcbiAgICBsb2dDbGllbnRFcnJvcihyZW1vdGVFcnJvcik7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxsYmFjayk7XG4gIH1cblxuICBjb25zdCBleHBvc2VkID0gcmVtb3RlLmV4cG9zZXMuZmluZCgoZSkgPT4gZS5rZXkgPT09IG9wdGlvbnMuZXhwb3NlZE1vZHVsZSk7XG5cbiAgY29uc3QgZXhwb3NlZEVycm9yID0gIWV4cG9zZWRcbiAgICA/IGBVbmtub3duIGV4cG9zZWQgbW9kdWxlICR7b3B0aW9ucy5leHBvc2VkTW9kdWxlfSBpbiByZW1vdGUgJHtyZW1vdGVOYW1lfWBcbiAgICA6ICcnO1xuXG4gIGlmICghZXhwb3NlZCAmJiAhZmFsbGJhY2spIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoZXhwb3NlZEVycm9yKTtcbiAgfSBlbHNlIGlmICghZXhwb3NlZCkge1xuICAgIGxvZ0NsaWVudEVycm9yKGV4cG9zZWRFcnJvcik7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxsYmFjayk7XG4gIH1cblxuICBjb25zdCB1cmwgPSBqb2luUGF0aHMocmVtb3RlLmJhc2VVcmwsIGV4cG9zZWQub3V0RmlsZU5hbWUpO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgbW9kdWxlID0gX2ltcG9ydDxUPih1cmwpO1xuICAgIHJldHVybiBtb2R1bGU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZmFsbGJhY2spIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2Vycm9yIGxvYWRpbmcgcmVtb3RlIG1vZHVsZScsIGUpO1xuICAgICAgcmV0dXJuIGZhbGxiYWNrO1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9XG59XG5cbmZ1bmN0aW9uIF9pbXBvcnQ8VCA9IGFueT4odXJsOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHR5cGVvZiBpbXBvcnRTaGltICE9PSAndW5kZWZpbmVkJ1xuICAgID8gaW1wb3J0U2hpbTxUPih1cmwpXG4gICAgOiAoaW1wb3J0KC8qIEB2aXRlLWlnbm9yZSAqLyB1cmwpIGFzIFQpO1xufVxuXG5mdW5jdGlvbiBnZXRSZW1vdGVOYW1lQnlPcHRpb25zKG9wdGlvbnM6IExvYWRSZW1vdGVNb2R1bGVPcHRpb25zKSB7XG4gIGxldCByZW1vdGVOYW1lO1xuXG4gIGlmIChvcHRpb25zLnJlbW90ZU5hbWUpIHtcbiAgICByZW1vdGVOYW1lID0gb3B0aW9ucy5yZW1vdGVOYW1lO1xuICB9IGVsc2UgaWYgKG9wdGlvbnMucmVtb3RlRW50cnkpIHtcbiAgICBjb25zdCBiYXNlVXJsID0gZ2V0RGlyZWN0b3J5KG9wdGlvbnMucmVtb3RlRW50cnkpO1xuICAgIHJlbW90ZU5hbWUgPSBnZXRSZW1vdGVOYW1lQnlCYXNlVXJsKGJhc2VVcmwpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICd1bmV4cGN0ZWQgYXJndW1lbnRzOiBQbGVhc2UgcGFzcyByZW1vdGVOYW1lIG9yIHJlbW90ZUVudHJ5J1xuICAgICk7XG4gIH1cblxuICBpZiAoIXJlbW90ZU5hbWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vua25vd24gcmVtb3RlTmFtZSAnICsgcmVtb3RlTmFtZSk7XG4gIH1cbiAgcmV0dXJuIHJlbW90ZU5hbWU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGVuc3VyZVJlbW90ZUluaXRpYWxpemVkKFxuICBvcHRpb25zOiBMb2FkUmVtb3RlTW9kdWxlT3B0aW9uc1xuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGlmIChcbiAgICBvcHRpb25zLnJlbW90ZUVudHJ5ICYmXG4gICAgIWlzUmVtb3RlSW5pdGlhbGl6ZWQoZ2V0RGlyZWN0b3J5KG9wdGlvbnMucmVtb3RlRW50cnkpKVxuICApIHtcbiAgICBjb25zdCBpbXBvcnRNYXAgPSBhd2FpdCBwcm9jZXNzUmVtb3RlSW5mbyhvcHRpb25zLnJlbW90ZUVudHJ5KTtcbiAgICBhcHBlbmRJbXBvcnRNYXAoaW1wb3J0TWFwKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBub3JtYWxpemVPcHRpb25zKFxuICBvcHRpb25zT3JSZW1vdGVOYW1lOiBzdHJpbmcgfCBMb2FkUmVtb3RlTW9kdWxlT3B0aW9ucyxcbiAgZXhwb3NlZE1vZHVsZTogc3RyaW5nIHwgdW5kZWZpbmVkXG4pOiBMb2FkUmVtb3RlTW9kdWxlT3B0aW9ucyB7XG4gIGxldCBvcHRpb25zOiBMb2FkUmVtb3RlTW9kdWxlT3B0aW9ucztcblxuICBpZiAodHlwZW9mIG9wdGlvbnNPclJlbW90ZU5hbWUgPT09ICdzdHJpbmcnICYmIGV4cG9zZWRNb2R1bGUpIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgcmVtb3RlTmFtZTogb3B0aW9uc09yUmVtb3RlTmFtZSxcbiAgICAgIGV4cG9zZWRNb2R1bGUsXG4gICAgfTtcbiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uc09yUmVtb3RlTmFtZSA9PT0gJ29iamVjdCcgJiYgIWV4cG9zZWRNb2R1bGUpIHtcbiAgICBvcHRpb25zID0gb3B0aW9uc09yUmVtb3RlTmFtZTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAndW5leHBlY3RlZCBhcmd1bWVudHM6IHBsZWFzZSBwYXNzIG9wdGlvbnMgb3IgYSByZW1vdGVOYW1lL2V4cG9zZWRNb2R1bGUtcGFpcidcbiAgICApO1xuICB9XG4gIHJldHVybiBvcHRpb25zO1xufVxuXG5mdW5jdGlvbiBsb2dDbGllbnRFcnJvcihlcnJvcjogc3RyaW5nKTogdm9pZCB7XG4gIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICB9XG59XG4iXX0=