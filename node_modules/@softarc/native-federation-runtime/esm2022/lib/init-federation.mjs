import { mergeImportMaps, } from './model/import-map';
import { getExternalUrl, setExternalUrl } from './model/externals';
import { getDirectory, joinPaths } from './utils/path-utils';
import { addRemote } from './model/remotes';
import { appendImportMap } from './utils/add-import-map';
/**
 * Initialize the federation runtime
 * @param remotesOrManifestUrl
 * @param options The cacheTag allows you to invalidate the cache of the remoteEntry.json files, pass a new value with every release (f.ex. the version number)
 */
export async function initFederation(remotesOrManifestUrl = {}, options) {
    const cacheOption = options?.cacheTag ? `?t=${options.cacheTag}` : '';
    const remotes = typeof remotesOrManifestUrl === 'string'
        ? await loadManifest(remotesOrManifestUrl + cacheOption)
        : remotesOrManifestUrl;
    const url = './remoteEntry.json' + cacheOption;
    const hostInfo = await loadFederationInfo(url);
    const hostImportMap = await processHostInfo(hostInfo);
    const remotesImportMap = await processRemoteInfos(remotes, {
        throwIfRemoteNotFound: false,
        ...options,
    });
    const importMap = mergeImportMaps(hostImportMap, remotesImportMap);
    appendImportMap(importMap);
    return importMap;
}
async function loadManifest(remotes) {
    return (await fetch(remotes).then((r) => r.json()));
}
export async function processRemoteInfos(remotes, options = { throwIfRemoteNotFound: false }) {
    const processRemoteInfoPromises = Object.keys(remotes).map(async (remoteName) => {
        try {
            let url = remotes[remoteName];
            if (options.cacheTag) {
                const addAppend = remotes[remoteName].includes('?') ? '&' : '?';
                url += `${addAppend}t=${options.cacheTag}`;
            }
            return await processRemoteInfo(url, remoteName);
        }
        catch (e) {
            const error = `Error loading remote entry for ${remoteName} from file ${remotes[remoteName]}`;
            if (options.throwIfRemoteNotFound) {
                throw new Error(error);
            }
            console.error(error);
            return null;
        }
    });
    const remoteImportMaps = await Promise.all(processRemoteInfoPromises);
    const importMap = remoteImportMaps.reduce((acc, remoteImportMap) => remoteImportMap ? mergeImportMaps(acc, remoteImportMap) : acc, { imports: {}, scopes: {} });
    return importMap;
}
export async function processRemoteInfo(federationInfoUrl, remoteName) {
    const baseUrl = getDirectory(federationInfoUrl);
    const remoteInfo = await loadFederationInfo(federationInfoUrl);
    if (!remoteName) {
        remoteName = remoteInfo.name;
    }
    const importMap = createRemoteImportMap(remoteInfo, remoteName, baseUrl);
    addRemote(remoteName, { ...remoteInfo, baseUrl });
    return importMap;
}
function createRemoteImportMap(remoteInfo, remoteName, baseUrl) {
    const imports = processExposed(remoteInfo, remoteName, baseUrl);
    const scopes = processRemoteImports(remoteInfo, baseUrl);
    return { imports, scopes };
}
async function loadFederationInfo(url) {
    const info = (await fetch(url).then((r) => r.json()));
    return info;
}
function processRemoteImports(remoteInfo, baseUrl) {
    const scopes = {};
    const scopedImports = {};
    for (const shared of remoteInfo.shared) {
        const outFileName = getExternalUrl(shared) ?? joinPaths(baseUrl, shared.outFileName);
        setExternalUrl(shared, outFileName);
        scopedImports[shared.packageName] = outFileName;
    }
    scopes[baseUrl + '/'] = scopedImports;
    return scopes;
}
function processExposed(remoteInfo, remoteName, baseUrl) {
    const imports = {};
    for (const exposed of remoteInfo.exposes) {
        const key = joinPaths(remoteName, exposed.key);
        const value = joinPaths(baseUrl, exposed.outFileName);
        imports[key] = value;
    }
    return imports;
}
export async function processHostInfo(hostInfo, relBundlesPath = './') {
    const imports = hostInfo.shared.reduce((acc, cur) => ({
        ...acc,
        [cur.packageName]: relBundlesPath + cur.outFileName,
    }), {});
    for (const shared of hostInfo.shared) {
        setExternalUrl(shared, relBundlesPath + shared.outFileName);
    }
    return { imports, scopes: {} };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC1mZWRlcmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uYXRpdmUtZmVkZXJhdGlvbi1ydW50aW1lL3NyYy9saWIvaW5pdC1mZWRlcmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFHTCxlQUFlLEdBRWhCLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFPekQ7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsY0FBYyxDQUNsQyx1QkFBd0QsRUFBRSxFQUMxRCxPQUErQjtJQUUvQixNQUFNLFdBQVcsR0FBRyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxNQUFNLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3RFLE1BQU0sT0FBTyxHQUNYLE9BQU8sb0JBQW9CLEtBQUssUUFBUTtRQUN0QyxDQUFDLENBQUMsTUFBTSxZQUFZLENBQUMsb0JBQW9CLEdBQUcsV0FBVyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxvQkFBb0IsQ0FBQztJQUUzQixNQUFNLEdBQUcsR0FBRyxvQkFBb0IsR0FBRyxXQUFXLENBQUM7SUFDL0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvQyxNQUFNLGFBQWEsR0FBRyxNQUFNLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0RCxNQUFNLGdCQUFnQixHQUFHLE1BQU0sa0JBQWtCLENBQUMsT0FBTyxFQUFFO1FB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MEIsRUFDMUIsVUFBa0IsRUFDbEIsT0FBZTtJQUVmLE1BQU0sT0FBTyxHQUFZLEVBQUUsQ0FBQztJQUU1QixLQUFLLE1BQU0sT0FBTyxJQUFJLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN6QyxNQUFNLEdBQUcsR0FBRyxTQUFTLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQyxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0RCxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDO0FBRUQsTUFBTSxDQUFDLEtBQUssVUFBVSxlQUFlLENBQ25DLFFBQXdCLEVBQ3hCLGNBQWMsR0FBRyxJQUFJO0lBRXJCLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUNwQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDYixHQUFHLEdBQUc7UUFDTixDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxjQUFjLEdBQUcsR0FBRyxDQUFDLFdBQVc7S0FDcEQsQ0FBQyxFQUNGLEVBQUUsQ0FDUSxDQUFDO0lBRWIsS0FBSyxNQUFNLE1BQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDckMsY0FBYyxDQUFDLE1BQU0sRUFBRSxjQUFjLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFDRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsQ0FBQztBQUNqQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW1wb3J0TWFwLFxuICBJbXBvcnRzLFxuICBtZXJnZUltcG9ydE1hcHMsXG4gIFNjb3Blcyxcbn0gZnJvbSAnLi9tb2RlbC9pbXBvcnQtbWFwJztcbmltcG9ydCB7IGdldEV4dGVybmFsVXJsLCBzZXRFeHRlcm5hbFVybCB9IGZyb20gJy4vbW9kZWwvZXh0ZXJuYWxzJztcbmltcG9ydCB7IGdldERpcmVjdG9yeSwgam9pblBhdGhzIH0gZnJvbSAnLi91dGlscy9wYXRoLXV0aWxzJztcbmltcG9ydCB7IGFkZFJlbW90ZSB9IGZyb20gJy4vbW9kZWwvcmVtb3Rlcyc7XG5pbXBvcnQgeyBhcHBlbmRJbXBvcnRNYXAgfSBmcm9tICcuL3V0aWxzL2FkZC1pbXBvcnQtbWFwJztcbmltcG9ydCB7XG4gIEZlZGVyYXRpb25JbmZvLFxuICBJbml0RmVkZXJhdGlvbk9wdGlvbnMsXG4gIFByb2Nlc3NSZW1vdGVJbmZvT3B0aW9ucyxcbn0gZnJvbSAnLi9tb2RlbC9mZWRlcmF0aW9uLWluZm8nO1xuXG4vKipcbiAqIEluaXRpYWxpemUgdGhlIGZlZGVyYXRpb24gcnVudGltZVxuICogQHBhcmFtIHJlbW90ZXNPck1hbmlmZXN0VXJsXG4gKiBAcGFyYW0gb3B0aW9ucyBUaGUgY2FjaGVUYWcgYWxsb3dzIHlvdSB0byBpbnZhbGlkYXRlIHRoZSBjYWNoZSBvZiB0aGUgcmVtb3RlRW50cnkuanNvbiBmaWxlcywgcGFzcyBhIG5ldyB2YWx1ZSB3aXRoIGV2ZXJ5IHJlbGVhc2UgKGYuZXguIHRoZSB2ZXJzaW9uIG51bWJlcilcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRGZWRlcmF0aW9uKFxuICByZW1vdGVzT3JNYW5pZmVzdFVybDogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB8IHN0cmluZyA9IHt9LFxuICBvcHRpb25zPzogSW5pdEZlZGVyYXRpb25PcHRpb25zXG4pOiBQcm9taXNlPEltcG9ydE1hcD4ge1xuICBjb25zdCBjYWNoZU9wdGlvbiA9IG9wdGlvbnM/LmNhY2hlVGFnID8gYD90PSR7b3B0aW9ucy5jYWNoZVRhZ31gIDogJyc7XG4gIGNvbnN0IHJlbW90ZXMgPVxuICAgIHR5cGVvZiByZW1vdGVzT3JNYW5pZmVzdFVybCA9PT0gJ3N0cmluZydcbiAgICAgID8gYXdhaXQgbG9hZE1hbmlmZXN0KHJlbW90ZXNPck1hbmlmZXN0VXJsICsgY2FjaGVPcHRpb24pXG4gICAgICA6IHJlbW90ZXNPck1hbmlmZXN0VXJsO1xuXG4gIGNvbnN0IHVybCA9ICcuL3JlbW90ZUVudHJ5Lmpzb24nICsgY2FjaGVPcHRpb247XG4gIGNvbnN0IGhvc3RJbmZvID0gYXdhaXQgbG9hZEZlZGVyYXRpb25JbmZvKHVybCk7XG4gIGNvbnN0IGhvc3RJbXBvcnRNYXAgPSBhd2FpdCBwcm9jZXNzSG9zdEluZm8oaG9zdEluZm8pO1xuICBjb25zdCByZW1vdGVzSW1wb3J0TWFwID0gYXdhaXQgcHJvY2Vzc1JlbW90ZUluZm9zKHJlbW90ZXMsIHtcbiAgICB0aHJvd0lmUmVtb3RlTm90Rm91bmQ6IGZhbHNlLFxuICAgIC4uLm9wdGlvbnMsXG4gIH0pO1xuXG4gIGNvbnN0IGltcG9ydE1hcCA9IG1lcmdlSW1wb3J0TWFwcyhob3N0SW1wb3J0TWFwLCByZW1vdGVzSW1wb3J0TWFwKTtcbiAgYXBwZW5kSW1wb3J0TWFwKGltcG9ydE1hcCk7XG5cbiAgcmV0dXJuIGltcG9ydE1hcDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9hZE1hbmlmZXN0KHJlbW90ZXM6IHN0cmluZyk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgc3RyaW5nPj4ge1xuICByZXR1cm4gKGF3YWl0IGZldGNoKHJlbW90ZXMpLnRoZW4oKHIpID0+IHIuanNvbigpKSkgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NSZW1vdGVJbmZvcyhcbiAgcmVtb3RlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgb3B0aW9uczogUHJvY2Vzc1JlbW90ZUluZm9PcHRpb25zID0geyB0aHJvd0lmUmVtb3RlTm90Rm91bmQ6IGZhbHNlIH1cbik6IFByb21pc2U8SW1wb3J0TWFwPiB7XG4gIGNvbnN0IHByb2Nlc3NSZW1vdGVJbmZvUHJvbWlzZXMgPSBPYmplY3Qua2V5cyhyZW1vdGVzKS5tYXAoXG4gICAgYXN5bmMgKHJlbW90ZU5hbWUpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCB1cmwgPSByZW1vdGVzW3JlbW90ZU5hbWVdO1xuICAgICAgICBpZiAob3B0aW9ucy5jYWNoZVRhZykge1xuICAgICAgICAgIGNvbnN0IGFkZEFwcGVuZCA9IHJlbW90ZXNbcmVtb3RlTmFtZV0uaW5jbHVkZXMoJz8nKSA/ICcmJyA6ICc/JztcbiAgICAgICAgICB1cmwgKz0gYCR7YWRkQXBwZW5kfXQ9JHtvcHRpb25zLmNhY2hlVGFnfWA7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYXdhaXQgcHJvY2Vzc1JlbW90ZUluZm8odXJsLCByZW1vdGVOYW1lKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc3QgZXJyb3IgPSBgRXJyb3IgbG9hZGluZyByZW1vdGUgZW50cnkgZm9yICR7cmVtb3RlTmFtZX0gZnJvbSBmaWxlICR7cmVtb3Rlc1tyZW1vdGVOYW1lXX1gO1xuXG4gICAgICAgIGlmIChvcHRpb25zLnRocm93SWZSZW1vdGVOb3RGb3VuZCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfVxuICApO1xuXG4gIGNvbnN0IHJlbW90ZUltcG9ydE1hcHMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9jZXNzUmVtb3RlSW5mb1Byb21pc2VzKTtcblxuICBjb25zdCBpbXBvcnRNYXAgPSByZW1vdGVJbXBvcnRNYXBzLnJlZHVjZTxJbXBvcnRNYXA+KFxuICAgIChhY2MsIHJlbW90ZUltcG9ydE1hcCkgPT5cbiAgICAgIHJlbW90ZUltcG9ydE1hcCA/IG1lcmdlSW1wb3J0TWFwcyhhY2MsIHJlbW90ZUltcG9ydE1hcCkgOiBhY2MsXG4gICAgeyBpbXBvcnRzOiB7fSwgc2NvcGVzOiB7fSB9XG4gICk7XG5cbiAgcmV0dXJuIGltcG9ydE1hcDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NSZW1vdGVJbmZvKFxuICBmZWRlcmF0aW9uSW5mb1VybDogc3RyaW5nLFxuICByZW1vdGVOYW1lPzogc3RyaW5nXG4pOiBQcm9taXNlPEltcG9ydE1hcD4ge1xuICBjb25zdCBiYXNlVXJsID0gZ2V0RGlyZWN0b3J5KGZlZGVyYXRpb25JbmZvVXJsKTtcbiAgY29uc3QgcmVtb3RlSW5mbyA9IGF3YWl0IGxvYWRGZWRlcmF0aW9uSW5mbyhmZWRlcmF0aW9uSW5mb1VybCk7XG5cbiAgaWYgKCFyZW1vdGVOYW1lKSB7XG4gICAgcmVtb3RlTmFtZSA9IHJlbW90ZUluZm8ubmFtZTtcbiAgfVxuXG4gIGNvbnN0IGltcG9ydE1hcCA9IGNyZWF0ZVJlbW90ZUltcG9ydE1hcChyZW1vdGVJbmZvLCByZW1vdGVOYW1lLCBiYXNlVXJsKTtcbiAgYWRkUmVtb3RlKHJlbW90ZU5hbWUsIHsgLi4ucmVtb3RlSW5mbywgYmFzZVVybCB9KTtcblxuICByZXR1cm4gaW1wb3J0TWFwO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSZW1vdGVJbXBvcnRNYXAoXG4gIHJlbW90ZUluZm86IEZlZGVyYXRpb25JbmZvLFxuICByZW1vdGVOYW1lOiBzdHJpbmcsXG4gIGJhc2VVcmw6IHN0cmluZ1xuKTogSW1wb3J0TWFwIHtcbiAgY29uc3QgaW1wb3J0cyA9IHByb2Nlc3NFeHBvc2VkKHJlbW90ZUluZm8sIHJlbW90ZU5hbWUsIGJhc2VVcmwpO1xuICBjb25zdCBzY29wZXMgPSBwcm9jZXNzUmVtb3RlSW1wb3J0cyhyZW1vdGVJbmZvLCBiYXNlVXJsKTtcbiAgcmV0dXJuIHsgaW1wb3J0cywgc2NvcGVzIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRGZWRlcmF0aW9uSW5mbyh1cmw6IHN0cmluZyk6IFByb21pc2U8RmVkZXJhdGlvbkluZm8+IHtcbiAgY29uc3QgaW5mbyA9IChhd2FpdCBmZXRjaCh1cmwpLnRoZW4oKHIpID0+IHIuanNvbigpKSkgYXMgRmVkZXJhdGlvbkluZm87XG4gIHJldHVybiBpbmZvO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzUmVtb3RlSW1wb3J0cyhcbiAgcmVtb3RlSW5mbzogRmVkZXJhdGlvbkluZm8sXG4gIGJhc2VVcmw6IHN0cmluZ1xuKTogU2NvcGVzIHtcbiAgY29uc3Qgc2NvcGVzOiBTY29wZXMgPSB7fTtcbiAgY29uc3Qgc2NvcGVkSW1wb3J0czogSW1wb3J0cyA9IHt9O1xuXG4gIGZvciAoY29uc3Qgc2hhcmVkIG9mIHJlbW90ZUluZm8uc2hhcmVkKSB7XG4gICAgY29uc3Qgb3V0RmlsZU5hbWUgPVxuICAgICAgZ2V0RXh0ZXJuYWxVcmwoc2hhcmVkKSA/PyBqb2luUGF0aHMoYmFzZVVybCwgc2hhcmVkLm91dEZpbGVOYW1lKTtcbiAgICBzZXRFeHRlcm5hbFVybChzaGFyZWQsIG91dEZpbGVOYW1lKTtcbiAgICBzY29wZWRJbXBvcnRzW3NoYXJlZC5wYWNrYWdlTmFtZV0gPSBvdXRGaWxlTmFtZTtcbiAgfVxuXG4gIHNjb3Blc1tiYXNlVXJsICsgJy8nXSA9IHNjb3BlZEltcG9ydHM7XG4gIHJldHVybiBzY29wZXM7XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NFeHBvc2VkKFxuICByZW1vdGVJbmZvOiBGZWRlcmF0aW9uSW5mbyxcbiAgcmVtb3RlTmFtZTogc3RyaW5nLFxuICBiYXNlVXJsOiBzdHJpbmdcbik6IEltcG9ydHMge1xuICBjb25zdCBpbXBvcnRzOiBJbXBvcnRzID0ge307XG5cbiAgZm9yIChjb25zdCBleHBvc2VkIG9mIHJlbW90ZUluZm8uZXhwb3Nlcykge1xuICAgIGNvbnN0IGtleSA9IGpvaW5QYXRocyhyZW1vdGVOYW1lLCBleHBvc2VkLmtleSk7XG4gICAgY29uc3QgdmFsdWUgPSBqb2luUGF0aHMoYmFzZVVybCwgZXhwb3NlZC5vdXRGaWxlTmFtZSk7XG4gICAgaW1wb3J0c1trZXldID0gdmFsdWU7XG4gIH1cblxuICByZXR1cm4gaW1wb3J0cztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NIb3N0SW5mbyhcbiAgaG9zdEluZm86IEZlZGVyYXRpb25JbmZvLFxuICByZWxCdW5kbGVzUGF0aCA9ICcuLydcbik6IFByb21pc2U8SW1wb3J0TWFwPiB7XG4gIGNvbnN0IGltcG9ydHMgPSBob3N0SW5mby5zaGFyZWQucmVkdWNlKFxuICAgIChhY2MsIGN1cikgPT4gKHtcbiAgICAgIC4uLmFjYyxcbiAgICAgIFtjdXIucGFja2FnZU5hbWVdOiByZWxCdW5kbGVzUGF0aCArIGN1ci5vdXRGaWxlTmFtZSxcbiAgICB9KSxcbiAgICB7fVxuICApIGFzIEltcG9ydHM7XG5cbiAgZm9yIChjb25zdCBzaGFyZWQgb2YgaG9zdEluZm8uc2hhcmVkKSB7XG4gICAgc2V0RXh0ZXJuYWxVcmwoc2hhcmVkLCByZWxCdW5kbGVzUGF0aCArIHNoYXJlZC5vdXRGaWxlTmFtZSk7XG4gIH1cbiAgcmV0dXJuIHsgaW1wb3J0cywgc2NvcGVzOiB7fSB9O1xufVxuIl19